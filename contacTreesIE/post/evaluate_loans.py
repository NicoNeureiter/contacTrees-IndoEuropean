import numpy as np
import pandas as pd

class color:
   PURPLE = '\033[95m'
   CYAN = '\033[96m'
   DARKCYAN = '\033[36m'
   BLUE = '\033[94m'
   GREEN = '\033[92m'
   YELLOW = '\033[93m'
   RED = '\033[91m'
   BOLD = '\033[1m'
   UNDERLINE = '\033[4m'
   END = '\033[0m'

if __name__ == '__main__':
    import matplotlib.pyplot as plt

    # NEWICK = r"""((((38[&posterior=1.0, height_95%_HPD={1234.2099979054024,1234.2099979054028}]:760.8556025748762,(37[&posterior=1.0, height_95%_HPD={1.8189894035458565E-12,1.8189894035458565E-12}]:1007.9665715007693,(39[&posterior=1.0, height_95%_HPD={1.8189894035458565E-12,2.7284841053187847E-12}]:544.2017713888429,#845[&conv=845, relSize=0.02, affectedBlocks="{cold,person,rope,they}", posterior=0.44504447268106734 ,blockPosterior={0.33592757306226173,0.3568932655654384,0.3252858958068615,0.2892312579415502}]:0.00001)[&height_95%_HPD={318.5630659778435,958.3397816187644}]:463.76480011192643)42[&posterior=1.0, height_95%_HPD={1007.9665715008368,1007.9665715008368}]:987.0990289795227)43[&posterior=1.0, height_95%_HPD={1995.0656004801144,1995.0656004801144}]:1151.8104041798981,((36[&posterior=1.0, height_95%_HPD={296.3438151944656,296.3438151944656}]:810.5706932162827,((34[&posterior=1.0, height_95%_HPD={1.8189894035458565E-12,1.8189894035458565E-12}]:217.45078786942395,35[&posterior=1.0, height_95%_HPD={1.8189894035458565E-12,1.8189894035458565E-12}]:217.45078786942395)44[&posterior=1.0, height_95%_HPD={217.4507878694003,217.4507878694003}]:260.9660318318586,33[&posterior=1.0, height_95%_HPD={1.8189894035458565E-12,1.8189894035458565E-12}]:478.4168197012825)45[&posterior=1.0, height_95%_HPD={478.41681970125137,478.41681970125137}]:628.4976887094451)46[&posterior=1.0, height_95%_HPD={1106.9145084107295,1106.9145084107295}]:441.80350896603204,((41[&posterior=1.0, height_95%_HPD={1.8189894035458565E-12,2.7284841053187847E-12}]:313.4262426898947,40[&posterior=1.0, height_95%_HPD={1.8189894035458565E-12,2.7284841053187847E-12}]:313.4262426898947)47[&posterior=1.0, height_95%_HPD={313.42624268994405,313.42624268994496}]:230.77552869894816)#845[&height_95%_HPD={318.5630659778435,958.3397816187644}]:1004.5162459879168)48[&posterior=1.0, height_95%_HPD={1548.7180173765246,1548.7180173765246}]:1598.1579872834304)49[&posterior=1.0, height_95%_HPD={3146.876004660279,3146.876004660279}]:1579.6264760218564,(22[&posterior=1.0, height_95%_HPD={2001.3055276321843,2001.3055276321843}]:284.9808546703259,(((((((30[&posterior=1.0, height_95%_HPD={9.094947017729282E-13,2.7284841053187847E-12}]:201.94603507516842,#6186[&conv=6186, relSize=0.02, affectedBlocks="{flow,leaf,sharp,spit,stand}", posterior=0.954574332909784 ,blockPosterior={0.9405972045743329,0.8368805590851334,0.9196315120711563,0.46172172808132145,0.9523506988564168}]:0.00001)[&height_95%_HPD={13.727525068782597,425.5429214377655}]:363.51260251477925,(23[&posterior=1.0, height_95%_HPD={9.094947017729282E-13,2.7284841053187847E-12}]:77.97945169592744,#8403[&conv=8403, relSize=0.02, affectedBlocks="{flow,husband,many,some,wife}", posterior=0.6605781448538754 ,blockPosterior={0.4963468869123253,0.613881829733164,0.5108005082592122,0.5187420584498094,0.6581956797966964}]:0.00001)[&height_95%_HPD={2.2501158310033134,242.72791369814604}]:487.47918589402025)50[&posterior=1.0, height_95%_HPD={565.4586375899116,565.4586375899116}]:424.8599290938075,(17[&posterior=1.0, height_95%_HPD={9.094947017729282E-13,2.7284841053187847E-12}]:204.22711099419368,#9976[&conv=9976, relSize=0.01, affectedBlocks="{because,heavy,river}", posterior=0.39501270648030495 ,blockPosterior={0.3854828462515883,0.3905654383735705,0.3872299872935197}]:0.00001)[&height_95%_HPD={7.846124251396759,459.0086263456351}]:786.0914556895615)51[&posterior=1.0, height_95%_HPD={990.3185666838881,990.3185666838881}]:280.5376470526395,((32[&posterior=1.0, height_95%_HPD={9.094947017729282E-13,1.8189894035458565E-12}]:318.2457173350865,(18[&posterior=1.0, height_95%_HPD={0.0,1.8189894035458565E-12}]:123.45033051826725,#9943[&conv=9943, relSize=0.04, affectedBlocks="{animal,count,lake,person,push,river,turn,vomit}", posterior=0.5390724269377383 ,blockPosterior={0.5088945362134689,0.46521601016518427,0.4950762388818297,0.35673443456162646,0.44043837357052096,0.46982210927573065,0.32226810673443457,0.4020012706480305}]:0.00001)[&height_95%_HPD={5.930467209492235,301.97035184776723}]:194.79538681681925)52[&posterior=1.0, height_95%_HPD={318.2457173351386,318.2457173351395}]:365.4906678404176,24[&posterior=1.0, height_95%_HPD={9.094947017729282E-13,1.8189894035458565E-12}]:683.7363851755041)53[&posterior=1.0, height_95%_HPD={683.7363851755063,683.7363851755063}]:587.1198285608915)54[&posterior=1.0, height_95%_HPD={1270.856213736498,1270.856213736498}]:134.60231955184918,(((21[&posterior=1.0, height_95%_HPD={9.094947017729282E-13,1.8189894035458565E-12}]:225.20630257884994,#1406[&conv=1406, relSize=0.01, affectedBlocks="{because,heavy,stab}", posterior=0.4093074968233799 ,blockPosterior={0.37833545108005084,0.4045425667090216,0.40533672172808133}]:0.00001)[&height_95%_HPD={43.10573857966392,452.858260695838}]:340.5321619124609,(25[&posterior=1.0, height_95%_HPD={0.0,1.8189894035458565E-12}]:254.6648712892157)#7976[&height_95%_HPD={75.9052446607966,345.64120728375747}]:311.07359320209514)55[&posterior=1.0, height_95%_HPD={565.7384644912499,565.7384644912499}]:602.4772581694247,(((20[&posterior=1.0, height_95%_HPD={0.0,1.8189894035458565E-12}]:77.97945169592836)#8403[&height_95%_HPD={2.2501158310033134,242.72791369814604}]:184.09810954328802,#3605[&conv=3605, relSize=0.05, affectedBlocks="{feather,head,near,rightside,small,thin,throw,turn,what,wife,wipe}", posterior=0.9955527318932655 ,blockPosterior={0.8783354510800508,0.8057496823379924,0.9567979669631512,0.9817344345616265,0.8459339263024143,0.9297966963151207,0.5632147395171537,0.42963786531130876,0.38707115628970773,0.6602604828462516,0.3624523506988564}]:0.00001)[&height_95%_HPD={65.46355868789578,517.494063591068}]:641.8562236182398,((19[&posterior=1.0, height_95%_HPD={0.0,1.8189894035458565E-12}]:254.66487128921568,#7976[&conv=7976, relSize=0.08, affectedBlocks="{bark,breast,cold,fight,kill,know,liver,louse,man,mountain,road,rotten,stand,tree,warm,woman}", posterior=0.9920584498094028 ,blockPosterior={0.7179161372299873,0.47855781448538753,0.6294472681067345,0.8819885641677255,0.9452033036848793,0.6926620076238882,0.7701715374841169,0.6963151207115629,0.7114040660736975,0.752858958068615,0.9010482846251588,0.6446950444726811,0.5357369758576874,0.8224269377382465,0.545425667090216,0.4780813214739517}]:0.00001)[&height_95%_HPD={75.9052446607966,345.64120728375747}]:0.3653551036347551)#4401[&height_95%_HPD={37.21484538107961,508.36273353494016}]:648.9035584646058)56[&posterior=1.0, height_95%_HPD={903.9337848575224,903.9337848575224}]:264.28193780327933)57[&posterior=1.0, height_95%_HPD={1168.2157226608015,1168.2157226608015}]:237.24281062750924)58[&posterior=1.0, height_95%_HPD={1405.4585332884017,1405.4585332884017}]:175.5446942732733,((((29[&posterior=1.0, height_95%_HPD={0.0,1.8189894035458565E-12}]:204.22711099419456)#9976[&height_95%_HPD={7.846124251396759,459.0086263456351}]:20.979191584655382)#1406[&height_95%_HPD={43.10573857966392,452.858260695838}]:258.072324866141,((27[&posterior=1.0, height_95%_HPD={0.0,1.8189894035458565E-12}]:201.9460350751693)#6186[&height_95%_HPD={13.727525068782597,425.5429214377655}]:107.54957073632534)#4340[&height_95%_HPD={35.458006791989646,471.9171976669504}]:173.78302163349633)59[&posterior=1.0, height_95%_HPD={483.27862744500726,483.27862744500726}]:171.85484774363806,(28[&posterior=1.0, height_95%_HPD={0.0,1.8189894035458565E-12}]:262.0775612392164)#3605[&height_95%_HPD={65.46355868789578,517.494063591068}]:393.0559139494127)60[&posterior=1.0, height_95%_HPD={655.1334751886106,655.1334751886106}]:925.869752372889)61[&posterior=1.0, height_95%_HPD={1581.0032275612948,1581.0032275612948}]:243.18811461547898,((26[&posterior=1.0, height_95%_HPD={1.8189894035458565E-12,2.7284841053187847E-12}]:309.49560581149376,#4340[&conv=4340, relSize=0.03, affectedBlocks="{guts,hit,scratch,some,spit,turn}", posterior=0.6894853875476493 ,blockPosterior={0.6834498094027954,0.5319250317662008,0.6804320203303685,0.6580368487928844,0.36102287166454894,0.5775095298602287}]:0.00001)[&height_95%_HPD={35.458006791989646,471.9171976669504}]:584.1057987712393,(31[&posterior=1.0, height_95%_HPD={9.094947017729282E-13,2.7284841053187847E-12}]:255.03022639284956,#4401[&conv=4401, relSize=0.01, affectedBlocks="{freeze,fruit,squeeze}", posterior=0.7031448538754765 ,blockPosterior={0.7010800508259212,0.6964739517153749,0.6518424396442185}]:0.00001)[&height_95%_HPD={37.21484538107961,508.36273353494016}]:638.5711781898835)62[&posterior=1.0, height_95%_HPD={893.6014045826296,893.6014045826296}]:930.5899375942631)63[&posterior=1.0, height_95%_HPD={1824.191342177127,1824.191342177127}]:462.0950401257712)64[&posterior=1.0, height_95%_HPD={2286.2863823030025,2286.2863823030025}]:2440.216098379279)65[&posterior=1.0, height_95%_HPD={4726.50248068237,4726.50248068237}]:499.85763569632854,(8[&posterior=1.0, height_95%_HPD={1649.523292265555,1649.523292265555}]:808.3769459367877,(((((((1[&posterior=1.0, height_95%_HPD={9.094947017729282E-13,2.7284841053187847E-12}]:88.16672673890447)#4638[&height_95%_HPD={1.7300811355589758,331.7840219056061}]:15.298997508936125)#2693[&height_95%_HPD={4.434557584684626,304.0631887316258}]:3.786079687265314)#2580[&height_95%_HPD={2.9740017551112032,402.74283322704014}]:252.6088586957774,#1399[&conv=1399, relSize=0.01, affectedBlocks="{belly,if}", posterior=0.3526048284625159 ,blockPosterior={0.32639771283354513,0.34926937738246505}]:0.00001)[&height_95%_HPD={172.63695674984228,454.47651870358004}]:377.9159227307184,((16[&posterior=1.0, height_95%_HPD={0.0,1.8189894035458565E-12}]:320.68834709144596,15[&posterior=1.0, height_95%_HPD={9.094947017729282E-13,1.8189894035458565E-12}]:320.68834709144596)66[&posterior=1.0, height_95%_HPD={320.68834709147814,320.68834709147905}]:185.94292872770427,(14[&posterior=1.0, height_95%_HPD={0.0,1.8189894035458565E-12}]:144.1685662505113)#4938[&height_95%_HPD={3.831850825438778,357.66683647566424}]:362.46270956863896)67[&posterior=1.0, height_95%_HPD={506.6312758191707,506.6312758191716}]:231.14530954245242)68[&posterior=1.0, height_95%_HPD={737.7765853616684,737.7765853616693}]:536.8708083874312,(13[&posterior=1.0, height_95%_HPD={765.6464337285106,765.6464337285106}]:222.64195869550326,(9[&posterior=1.0, height_95%_HPD={0.0,0.0}]:459.66116941767064,(4[&posterior=1.0, height_95%_HPD={0.0,0.0}]:359.86066263088514)#1399[&height_95%_HPD={172.63695674984228,454.47651870358004}]:99.80050678678549)69[&posterior=1.0, height_95%_HPD={459.6611694176918,459.6611694176918}]:528.6272230062757)70[&posterior=1.0, height_95%_HPD={988.2883924240014,988.2883924240014}]:286.35900132508846)71[&posterior=1.0, height_95%_HPD={1274.6473937488645,1274.6473937488645}]:571.8521082902175,((((((5[&posterior=1.0, height_95%_HPD={9.094947017729282E-13,2.7284841053187847E-12}]:144.16856625051037,#4938[&conv=4938, relSize=0.03, affectedBlocks="{back,big,heavy,seed,split,wide}", posterior=0.5964104193138501 ,blockPosterior={0.3167090216010165,0.5856099110546379,0.5883100381194409,0.5139771283354511,0.5889453621346887,0.3645171537484117}]:0.00001)[&height_95%_HPD={3.831850825438778,357.66683647566424}]:236.26908450402138,(2[&posterior=1.0, height_95%_HPD={9.094947017729282E-13,2.7284841053187847E-12}]:103.4657242478406,#2693[&conv=2693, relSize=0.00, affectedBlocks="{}", posterior=0.2885959339263024 ,blockPosterior={}]:0.00001)[&height_95%_HPD={4.434557584684626,304.0631887316258}]:276.97192650669115)72[&posterior=1.0, height_95%_HPD={380.4376507544821,380.4376507544839}]:141.32163014789592,#8817[&conv=8817, relSize=0.07, affectedBlocks="{at,bad,few,husband,many,rightside,rub,sew,small,smooth,vomit,wife,wing,woman}", posterior=0.841168996188056 ,blockPosterior={0.3986658195679797,0.6848792884371029,0.7503176620076238,0.32290343074968236,0.3416454891994917,0.33370393900889456,0.7723951715374842,0.3195679796696315,0.8262388818297332,0.3926302414231258,0.3167090216010165,0.613722998729352,0.4552096569250318,0.3829415501905972}]:0.00001)[&height_95%_HPD={479.2309184797996,603.405812083698}]:137.0514097995317,(6[&posterior=1.0, height_95%_HPD={9.094947017729282E-13,2.7284841053187847E-12}]:107.25180393510591,#2580[&conv=2580, relSize=0.00, affectedBlocks="{pull}", posterior=0.2949491740787802 ,blockPosterior={0.2943138500635324}]:0.00001)[&height_95%_HPD={2.9740017551112032,402.74283322704014}]:551.5588867668534)73[&posterior=1.0, height_95%_HPD={658.8106907019983,658.8106907019983}]:678.504040042892,(12[&posterior=1.0, height_95%_HPD={1014.8654442334264,1014.8654442334264}]:289.6151585887568,((7[&posterior=1.0, height_95%_HPD={9.094947017729282E-13,2.7284841053187847E-12}]:476.8704902262969,(10[&posterior=1.0, height_95%_HPD={9.094947017729282E-13,2.7284841053187847E-12}]:88.16672673890447,#4638[&conv=4638, relSize=0.01, affectedBlocks="{scratch,squeeze}", posterior=0.3622935196950445 ,blockPosterior={0.33592757306226173,0.29367852604828465}]:0.00001)[&height_95%_HPD={1.7300811355589758,331.7840219056061}]:388.7037634873924)74[&posterior=1.0, height_95%_HPD={476.8704902262698,476.8704902262716}]:44.88879067613078)#8817[&height_95%_HPD={479.2309184797996,603.405812083698}]:782.7213219198927)75[&posterior=1.0, height_95%_HPD={1304.4806028224457,1304.4806028224457}]:32.834127922531025)76[&posterior=1.0, height_95%_HPD={1337.3147307449517,1337.3147307449517}]:223.56050311192143,(11[&posterior=1.0, height_95%_HPD={998.6986022383462,998.6986022383462}]:185.43720022615628,(3[&posterior=1.0, height_95%_HPD={0.0,1.8189894035458565E-12}]:123.45033051826724)#9943[&height_95%_HPD={5.930467209492235,301.97035184776723}]:1060.685471946307)77[&posterior=1.0, height_95%_HPD={1184.1358024646502,1184.1358024646502}]:376.73943139219955)78[&posterior=1.0, height_95%_HPD={1560.8752338566046,1560.8752338566046}]:285.62426818247764)79[&posterior=1.0, height_95%_HPD={1846.4995020394613,1846.4995020394613}]:611.4007361632241)80[&posterior=1.0, height_95%_HPD={2457.900238202236,2457.900238202236}]:2768.4598781759005)81[&posterior=1.0, height_95%_HPD={5226.360116379046,5226.360116379046}]:0.0;"""

    loans_known = pd.read_csv('../../loans.csv', index_col=0)
    # loans_known.columns = loans_known.columns.str.lower()
    # loans_reconstructed = pd.read_csv('loan.log', sep='\t', names=['language', 'word', 'p'])
    # loans_reconstructed = loans_reconstructed.pivot(index='language', columns='word', values='p').fillna(0.)
    # loans_reconstructed.columns = loans_reconstructed.columns.str.lower()
    loans_reconstructed = pd.read_csv('results/remote/run_expconv=1_linear/loanwords.log', index_col=0)

    # loans_known = loans_known.sort_index(axis=0).sort_index(axis=1)
    # loans_reconstructed = loans_reconstructed.sort_index(axis=0).sort_index(axis=1)

    loans_known['WORD'] = loans_known.index
    loans_reconstructed['WORD'] = loans_reconstructed.index
    loans_known = pd.melt(loans_known, id_vars='WORD', var_name='LANGUAGE', value_name='truth')
    loans_reconstructed = pd.melt(loans_reconstructed, id_vars='WORD', var_name='LANGUAGE', value_name='p')

    loans = loans_known.join(loans_reconstructed.set_index(['WORD', 'LANGUAGE']), on=['WORD', 'LANGUAGE'])
    loans['p'] = loans['p'].fillna(0.0)
    loans = loans.sort_values('p', ascending=False)

    # Print significant false positives:
    fal_pos = loans[~loans.truth & (loans.p > 0.8)]
    print(fal_pos)

    fig, axes = plt.subplots(1, 3)

    for lang in loans.LANGUAGE.unique():
        x = loans[loans.LANGUAGE == lang]

        tru_pos = np.cumsum(x.truth)
        tru = np.sum(x.truth)
        pos = np.arange(len(x.truth)) + 1
        recall = tru_pos / tru
        precision = tru_pos / pos
        f1 = 2 * (precision * recall) / (precision + recall)

        # print(color.BOLD + f'{lang}     [Known loans: {tru}]' + color.END)

        if tru >= 5:
            axes[0].plot(pos, recall, label=lang, lw=1)
            axes[1].plot(pos, precision, label=lang, lw=1)
            axes[2].plot(recall, precision, label=lang, lw=1)
            # axes[2].plot(pos, f1, label=lang, lw=1)

    #         w = 1 - np.linspace(-1, 1, 8)**2
    #         w = w / np.sum(w)
    #         axes[2].plot(x.p, np.convolve(x.truth, w, mode='same'), label=lang)
    #
    # axes[2].plot([0, 1], color='gray', lw=0.5, ls='dashed')

    # for title, ax in zip(['Recall', 'Precision', 'F1-score'], axes):
    for title, ax in zip(['Recall', 'Precision', 'Recall -- Precision'], axes):
        ax.legend()
        ax.set_ylim(0, 1)
        ax.set_title(title)

    # axes[2].set_xlim(0, 1)
    # axes[0].legend()
    # axes[1].legend()
    # axes[2].legend()

    plt.tight_layout(pad=0.05, w_pad=0.0)
    plt.show()
